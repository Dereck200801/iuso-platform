-- =====================================================================
-- TEST D'INSCRIPTION COMPL√àTE IUSO PLATFORM
-- Simule une inscription compl√®te depuis le formulaire jusqu'√† l'enregistrement
-- dans la table inscrits apr√®s confirmation d'email
-- =====================================================================

-- Configuration du test
\set test_email 'candidat.test@exemple.com'
\set test_prenom 'Jean'
\set test_nom 'DUPONT'
\set test_genre 'masculin'
\set test_date_naissance '2000-06-15'
\set test_lieu_naissance 'Libreville'
\set test_nationalite 'Gabon'
\set test_telephone '+241 01 02 03 04'
\set test_adresse '123 Avenue des Tests, Libreville'
\set test_cycle 'licence1'
\set test_filiere 'Management des Organisations'
\set test_password 'MotDePasse123!'

RAISE NOTICE '==========================================';
RAISE NOTICE 'üß™ D√âBUT DU TEST D''INSCRIPTION COMPL√àTE';
RAISE NOTICE '==========================================';

-- =====================================================================
-- √âTAPE 1: PR√âPARATION DU TEST
-- =====================================================================

RAISE NOTICE 'üìã √âtape 1: Pr√©paration du test...';

-- Nettoyer les donn√©es de test pr√©c√©dentes
DELETE FROM public.inscrits WHERE email = :'test_email';
DELETE FROM public.inscrits_temp WHERE data->>'email' = :'test_email';

-- Supprimer l'utilisateur de test s'il existe
DELETE FROM auth.users WHERE email = :'test_email';

RAISE NOTICE '‚úÖ Donn√©es de test nettoy√©es';

-- =====================================================================
-- √âTAPE 2: SIMULATION CR√âATION COMPTE SUPABASE AUTH
-- =====================================================================

RAISE NOTICE 'üìã √âtape 2: Simulation cr√©ation compte Supabase Auth...';

-- Ins√©rer un utilisateur de test dans auth.users (simulation)
-- Note: En r√©alit√©, ceci est fait par supabase.auth.signUp()
INSERT INTO auth.users (
    id,
    email,
    encrypted_password,
    email_confirmed_at,
    created_at,
    updated_at,
    raw_user_meta_data,
    role,
    aud
) VALUES (
    gen_random_uuid(),
    :'test_email',
    crypt(:'test_password', gen_salt('bf')),
    NULL, -- Email pas encore confirm√©
    NOW(),
    NOW(),
    jsonb_build_object(
        'firstName', :'test_prenom',
        'lastName', :'test_nom',
        'role', 'candidat'
    ),
    'authenticated',
    'authenticated'
) RETURNING id as user_id;

-- R√©cup√©rer l'ID utilisateur cr√©√©
\gset

SELECT id FROM auth.users WHERE email = :'test_email' LIMIT 1;
\gset user_id_result 

RAISE NOTICE '‚úÖ Utilisateur cr√©√© avec ID: %', :'user_id_result';

-- =====================================================================
-- √âTAPE 3: SIMULATION DES UPLOADS DE FICHIERS
-- =====================================================================

RAISE NOTICE 'üìã √âtape 3: Simulation upload des fichiers...';

-- Simuler l'upload des fichiers dans le storage
-- En r√©alit√©, les fichiers sont upload√©s via l'API Supabase Storage
INSERT INTO storage.objects (
    id,
    bucket_id,
    name,
    owner,
    created_at,
    updated_at,
    last_accessed_at,
    metadata
) VALUES 
(
    gen_random_uuid(),
    'pieces-candidats',
    'photos/photo_' || :'user_id_result' || '_' || extract(epoch from now()) || '.jpg',
    :'user_id_result'::uuid,
    NOW(),
    NOW(),
    NOW(),
    jsonb_build_object('size', 1024000, 'mimetype', 'image/jpeg')
),
(
    gen_random_uuid(),
    'pieces-candidats',
    'attestations-bac/bac_' || :'user_id_result' || '_' || extract(epoch from now()) || '.pdf',
    :'user_id_result'::uuid,
    NOW(),
    NOW(),
    NOW(),
    jsonb_build_object('size', 2048000, 'mimetype', 'application/pdf')
);

-- R√©cup√©rer les URLs des fichiers
SELECT name FROM storage.objects 
WHERE bucket_id = 'pieces-candidats' 
AND owner = :'user_id_result'::uuid 
AND name LIKE 'photos/%'
ORDER BY created_at DESC 
LIMIT 1;
\gset photo_url_result

SELECT name FROM storage.objects 
WHERE bucket_id = 'pieces-candidats' 
AND owner = :'user_id_result'::uuid 
AND name LIKE 'attestations-bac/%'
ORDER BY created_at DESC 
LIMIT 1;
\gset bac_url_result

RAISE NOTICE '‚úÖ Fichiers upload√©s:';
RAISE NOTICE '   üì∏ Photo: %', :'photo_url_result';
RAISE NOTICE '   üìú Attestation: %', :'bac_url_result';

-- =====================================================================
-- √âTAPE 4: STOCKAGE DES DONN√âES TEMPORAIRES
-- =====================================================================

RAISE NOTICE 'üìã √âtape 4: Stockage des donn√©es temporaires...';

-- Cr√©er les donn√©es d'inscription (√©quivalent de ce qui est stock√© en localStorage)
INSERT INTO public.inscrits_temp (
    user_id,
    data,
    created_at
) VALUES (
    :'user_id_result'::uuid,
    jsonb_build_object(
        'email', :'test_email',
        'prenom', :'test_prenom',
        'nom', :'test_nom',
        'genre', :'test_genre',
        'date_naissance', :'test_date_naissance',
        'lieu_naissance', :'test_lieu_naissance',
        'nationalite', :'test_nationalite',
        'telephone', :'test_telephone',
        'adresse', :'test_adresse',
        'cycle', :'test_cycle',
        'filiere', :'test_filiere',
        'photo_identite_url', :'photo_url_result',
        'attestation_bac_url', :'bac_url_result',
        'mot_de_passe', :'test_password',
        'statut', 'en_attente_confirmation',
        'inscription_date', NOW()::text
    ),
    NOW()
);

RAISE NOTICE '‚úÖ Donn√©es temporaires stock√©es';

-- V√©rifier le stockage temporaire
SELECT COUNT(*) as count_temp FROM public.inscrits_temp WHERE user_id = :'user_id_result'::uuid;
\gset

RAISE NOTICE 'üìä Donn√©es temporaires: % enregistrement(s)', :'count_temp';

-- =====================================================================
-- √âTAPE 5: SIMULATION DE LA V√âRIFICATION D'EMAIL
-- =====================================================================

RAISE NOTICE 'üìã √âtape 5: Simulation v√©rification d''email...';

-- Marquer l'email comme v√©rifi√© (simulation du clic sur le lien de v√©rification)
UPDATE auth.users 
SET 
    email_confirmed_at = NOW(),
    updated_at = NOW()
WHERE id = :'user_id_result'::uuid;

RAISE NOTICE '‚úÖ Email v√©rifi√© pour l''utilisateur %', :'user_id_result';

-- =====================================================================
-- √âTAPE 6: TRANSFERT VERS LA TABLE INSCRITS
-- =====================================================================

RAISE NOTICE 'üìã √âtape 6: Transfert vers la table inscrits...';

-- R√©cup√©rer les donn√©es temporaires
SELECT data FROM public.inscrits_temp WHERE user_id = :'user_id_result'::uuid LIMIT 1;
\gset temp_data_result

-- Appeler la fonction de transfert
SELECT transfer_candidate_to_inscrits(
    :'user_id_result'::uuid,
    :'test_email',
    :'temp_data_result'::jsonb
) as transfer_result;
\gset

RAISE NOTICE '‚úÖ R√©sultat du transfert: %', :'transfer_result';

-- =====================================================================
-- √âTAPE 7: V√âRIFICATIONS FINALES
-- =====================================================================

RAISE NOTICE 'üìã √âtape 7: V√©rifications finales...';

-- V√©rifier que le candidat est bien dans la table inscrits
SELECT 
    COUNT(*) as count_inscrits,
    string_agg(numero_dossier, ', ') as numero_dossier,
    string_agg(statut, ', ') as statut
FROM public.inscrits 
WHERE email = :'test_email'
GROUP BY email;
\gset

-- R√©cup√©rer les d√©tails de l'inscription
SELECT 
    numero_dossier,
    prenom,
    nom,
    email,
    cycle,
    filiere,
    statut,
    auth_user_id,
    transferred_from_temp,
    email_verified_at IS NOT NULL as email_verifie,
    date_inscription
FROM public.inscrits 
WHERE email = :'test_email';

-- V√©rifications
DO $$
DECLARE 
    test_success BOOLEAN := true;
    inscrit_count INTEGER;
    user_exists BOOLEAN;
    email_confirmed BOOLEAN;
BEGIN
    -- Test 1: V√©rifier que l'utilisateur existe
    SELECT EXISTS(SELECT 1 FROM auth.users WHERE email = :'test_email') INTO user_exists;
    
    -- Test 2: V√©rifier que l'email est confirm√©
    SELECT email_confirmed_at IS NOT NULL 
    FROM auth.users 
    WHERE email = :'test_email' 
    INTO email_confirmed;
    
    -- Test 3: V√©rifier que le candidat est dans inscrits
    SELECT COUNT(*) FROM public.inscrits WHERE email = :'test_email' INTO inscrit_count;
    
    RAISE NOTICE '==========================================';
    RAISE NOTICE 'üèÅ R√âSULTATS DU TEST D''INSCRIPTION';
    RAISE NOTICE '==========================================';
    
    -- R√©sultats des tests
    IF user_exists THEN
        RAISE NOTICE '‚úÖ Test 1: Utilisateur cr√©√© dans auth.users';
    ELSE
        RAISE NOTICE '‚ùå Test 1: Utilisateur manquant dans auth.users';
        test_success := false;
    END IF;
    
    IF email_confirmed THEN
        RAISE NOTICE '‚úÖ Test 2: Email confirm√©';
    ELSE
        RAISE NOTICE '‚ùå Test 2: Email non confirm√©';
        test_success := false;
    END IF;
    
    IF inscrit_count = 1 THEN
        RAISE NOTICE '‚úÖ Test 3: Candidat enregistr√© dans table inscrits (% enregistrement)', inscrit_count;
    ELSE
        RAISE NOTICE '‚ùå Test 3: Probl√®me avec enregistrement inscrits (% enregistrements)', inscrit_count;
        test_success := false;
    END IF;
    
    -- V√©rifications suppl√©mentaires
    IF EXISTS(SELECT 1 FROM public.inscrits WHERE email = :'test_email' AND transferred_from_temp = true) THEN
        RAISE NOTICE '‚úÖ Test 4: Flag transferred_from_temp correctement d√©fini';
    ELSE
        RAISE NOTICE '‚ùå Test 4: Flag transferred_from_temp incorrect';
        test_success := false;
    END IF;
    
    IF EXISTS(SELECT 1 FROM public.inscrits WHERE email = :'test_email' AND numero_dossier IS NOT NULL) THEN
        RAISE NOTICE '‚úÖ Test 5: Num√©ro de dossier g√©n√©r√©';
    ELSE
        RAISE NOTICE '‚ùå Test 5: Num√©ro de dossier manquant';
        test_success := false;
    END IF;
    
    -- R√©sultat final
    RAISE NOTICE '==========================================';
    IF test_success THEN
        RAISE NOTICE 'üéâ TOUS LES TESTS R√âUSSIS !';
        RAISE NOTICE '‚úÖ Le processus d''inscription fonctionne correctement';
        RAISE NOTICE '‚úÖ Le candidat est bien enregistr√© apr√®s confirmation';
    ELSE
        RAISE NOTICE '‚ùå CERTAINS TESTS ONT √âCHOU√â !';
        RAISE NOTICE '‚ö†Ô∏è  Le syst√®me d''inscription n√©cessite des corrections';
    END IF;
    RAISE NOTICE '==========================================';
END $$;

-- =====================================================================
-- √âTAPE 8: STATISTIQUES FINALES
-- =====================================================================

RAISE NOTICE 'üìä Statistiques apr√®s test:';

SELECT 
    '√âtat final' as test_type,
    COUNT(*) as total_inscrits,
    COUNT(CASE WHEN statut = 'en_attente' THEN 1 END) as en_attente,
    COUNT(CASE WHEN transferred_from_temp = true THEN 1 END) as transferes_temp,
    COUNT(CASE WHEN auth_user_id IS NOT NULL THEN 1 END) as avec_auth_user
FROM public.inscrits;

-- =====================================================================
-- NETTOYAGE (OPTIONNEL)
-- =====================================================================

-- D√©commenter ces lignes si vous voulez nettoyer apr√®s le test
-- DELETE FROM public.inscrits WHERE email = :'test_email';
-- DELETE FROM public.inscrits_temp WHERE data->>'email' = :'test_email';
-- DELETE FROM auth.users WHERE email = :'test_email';
-- DELETE FROM storage.objects WHERE owner = :'user_id_result'::uuid;

RAISE NOTICE 'üìù Note: Les donn√©es de test sont conserv√©es pour inspection.';
RAISE NOTICE 'üìù D√©commentez les lignes de nettoyage si vous voulez les supprimer.';

RAISE NOTICE '==========================================';
RAISE NOTICE 'üèÅ TEST D''INSCRIPTION TERMIN√â';
RAISE NOTICE '=========================================='; 